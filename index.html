<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TISAL BUS MANAGER v36.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #005a9c; --secondary: #6c757d; --success: #28a745;
            --warning: #ffc107; --danger: #dc3545; --light: #f8f9fa;
            --dark: #343a40; --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; margin: 0; background-color: #eef2f7; color: #333; line-height: 1.6; }
        .header { background: linear-gradient(135deg, var(--primary), #003d6b); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
        .header h1 { margin: 0; font-size: 1.3rem; letter-spacing: 1px; }
        .container { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 20px; max-width: 1600px; margin: auto; }
        @media (min-width: 1024px) { .container { grid-template-columns: 1.5fr 1.5fr; } }
        .sidebar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 768px) { .sidebar-grid { grid-template-columns: 1fr; } }
        .card { background: white; padding: 18px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; border: none; }
        .card h3 { margin-top: 0; color: var(--primary); font-size: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .filter-box { background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .filter-box label { font-size: 0.7rem; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        .filter-box input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; }
        .stat-card { padding: 12px; border-radius: 10px; background: var(--light); text-align: center; border: 1px solid #e0e0e0; }
        .stat-card span { font-size: 0.75rem; color: #666; font-weight: bold; }
        .stat-card strong { display: block; font-size: 1rem; margin-top: 4px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day { border: 1px solid #eee; min-height: 100px; padding: 6px; font-size: 0.8em; cursor: pointer; border-radius: 8px; background: #fff; }
        .day:hover { background: #f0f7ff; }
        .day.empty { background: #f9f9f9; border: none; }
        .event { font-size: 0.7rem; padding: 3px 5px; border-radius: 4px; color: white; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        button { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-orange { background: #fd7e14; color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-gray { background: var(--secondary); color: white; }
        .info-item { padding: 12px; background: #fff; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.06); font-size: 0.85rem; }
        .info-item strong { display: block; font-size: 1rem; color: var(--primary); margin-bottom: 5px; }
        .detail-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 5px; }
        .badge-lunas { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge-dp { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .badge-blm { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .pickup-box { background: #fff8e1; padding: 8px; border-radius: 6px; border-left: 3px solid #ffc107; margin-top: 5px; font-size: 0.8rem; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 5vh auto; padding: 25px; width: 90%; max-width: 550px; border-radius: 15px; max-height: 85vh; overflow-y: auto; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.8rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; box-sizing: border-box; }
        .chart-container { margin-top: 25px; padding-top: 15px; border-top: 1px solid #f0f0f0; height: 280px; }
    </style>
</head>
<body>

    <header class="header">
        <h1>üöç TISAL BUS MANAGER <span style="font-weight:300">v36.0</span></h1>
        <div style="display:flex; gap:8px;">
            <button class="btn-green" onclick="openExportModal()">üìä Export Data</button>
            <button class="btn-gray" onclick="exportBackup()">üì• Backup All</button>
            <button class="btn-gray" onclick="document.getElementById('importFile').click()">üì§ Restore</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <div id="legal-alerts"></div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <div>
                        <button class="btn-blue" onclick="changeMonth(-1)">‚óÄ</button>
                        <span id="month-year" style="font-weight:bold; font-size:1.1rem; margin:0 10px; min-width:140px; display:inline-block; text-align:center;">Bulan</span>
                        <button class="btn-blue" onclick="changeMonth(1)">‚ñ∂</button>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-orange" onclick="openExpenseModal()">üí∏ Biaya OPS</button>
                        <button class="btn-gray" onclick="openFleetModal()">üöå Armada</button>
                        <button class="btn-blue" onclick="openScheduleModal()">üóìÔ∏è Jadwal</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>

            <div class="card">
                <h3>üí∞ Ringkasan Keuangan (Bulan Ini)</h3>
                <div class="stat-grid">
                    <div class="stat-card"><span>Omzet (Target)</span><strong id="st-omzet">0</strong></div>
                    <div class="stat-card" style="background:#fff9f9; border: 1px solid #f5c6cb;"><span>Piutang (Sisa)</span><strong id="st-piutang" style="color:var(--danger)">0</strong></div>
                    <div class="stat-card"><span>Masuk (Cash)</span><strong id="st-masuk">0</strong></div>
                    <div class="stat-card"><span>Biaya Ops</span><strong id="st-keluar">0</strong></div>
                    <div class="stat-card" style="background:#e7f3ff"><span>Laba Bersih</span><strong id="st-laba">0</strong></div>
                </div>
                <div class="chart-container"><canvas id="financeChart"></canvas></div>
            </div>

            <div class="card">
                <h3>üìä Detail Pengeluaran Operasional</h3>
                <div style="overflow-x:auto; max-height: 350px;">
                    <table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6; position: sticky; top: 0;">
                                <th style="padding:10px; text-align:left;">Tgl</th>
                                <th style="padding:10px; text-align:left;">Unit</th>
                                <th style="padding:10px; text-align:left;">Kategori</th>
                                <th style="padding:10px; text-align:left;">Ket</th>
                                <th style="padding:10px; text-align:right;">Nominal</th>
                                <th style="padding:10px; text-align:center;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="list-expenses-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
          
        <div class="sidebar-grid">
            <div class="sidebar-section">
                <div class="card">
                    <h3>üìÖ Jadwal Terdekat</h3>
                    <div class="filter-box">
                        <div><label>Dari:</label><input type="date" id="filter-start" onchange="renderSidebar()"></div>
                        <div><label>Sampai:</label><input type="date" id="filter-end" onchange="renderSidebar()"></div>
                    </div>
                    <div id="list-upcoming"></div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="card">
                    <h3>üí∏ Belum Lunas</h3>
                    <div id="list-unpaid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-expense" class="modal"><div class="modal-content">
        <h2 id="expense-modal-title">Catat Biaya Operasional</h2>
        <form id="expense-form">
            <input type="hidden" id="edit-expense-id">
            <div class="form-group"><label>Tanggal</label><input type="date" id="e-date" required></div>
            <div class="form-group"><label>Unit Bus Terkait</label><select id="e-bus" required></select></div>
            <div class="form-group"><label>Kategori</label><select id="e-cat"><option value="Solar">Solar / BBM</option><option value="Tol">Biaya Tol</option><option value="Gaji Sopir">Gaji Sopir</option><option value="Gaji Kernet">Gaji Kernet</option><option value="Service">Service</option><option value="Lainnya">Lainnya</option></select></div>
            <div class="form-group"><label>Nominal (Rp)</label><input type="number" id="e-amount" required></div>
            <div class="form-group"><label>Keterangan</label><input type="text" id="e-desc"></div>
            <div style="display:flex; gap:10px; margin-top:20px;"><button type="submit" id="btn-save-expense" class="btn-orange" style="flex:2; justify-content:center">SIMPAN BIAYA</button><button type="button" class="btn-gray" style="flex:1" onclick="closeModal()">BATAL</button></div>
        </form>
    </div></div>

    <div id="modal-form" class="modal"><div class="modal-content">
        <h2 id="sched-modal-title">Input Jadwal Sewa</h2>
        <form id="schedule-form">
            <input type="hidden" id="edit-id">
            <div class="form-group"><label>Nama Trip / Tujuan</label><input type="text" id="f-trip" required></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>Tanggal Berangkat</label><input type="date" id="f-date" required onchange="openScheduleModal()"></div>
                <div class="form-group"><label>Unit Bus</label><select id="f-bus" required></select></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>Nama Pemesan</label><input type="text" id="f-cust" required></div>
                <div class="form-group"><label>Nomor WA</label><input type="text" id="f-phone" required></div>
            </div>
            <div class="form-group"><label>üè† Alamat Lengkap Pemesan</label><textarea id="f-addr" rows="2"></textarea></div>
            <div class="form-group"><label>üìç Titik Jemput</label><textarea id="f-pickup" rows="2"></textarea></div>
            <div class="form-group"><label>Harga Sewa (Rp)</label><input type="number" id="f-price" required></div>
            <div class="form-group"><label>Status Pembayaran</label><select id="f-status" onchange="toggleDP(this.value)"><option value="Belum Bayar">Belum Bayar</option><option value="DP">DP (Uang Muka)</option><option value="Lunas">Lunas</option></select></div>
            <div id="dp-group" class="form-group" style="display:none; background:#f0fff4; padding:10px; border-radius:8px;"><label>Jumlah DP (Rp)</label><input type="number" id="f-dp"></div>
            <div style="display:flex; gap:10px; margin-top:20px;"><button type="submit" class="btn-blue" style="flex:2; justify-content:center">SIMPAN JADWAL</button><button type="button" class="btn-gray" style="flex:1" onclick="closeModal()">BATAL</button></div>
        </form>
    </div></div>

    <div id="modal-fleet" class="modal"><div class="modal-content">
        <h3>Kelola Armada</h3>
        <div id="fleet-list" style="margin-bottom:15px; max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px;"></div>
        <form id="fleet-form">
            <input type="hidden" id="bus-edit-id">
            <div class="form-group"><label id="fleet-form-title">Tambah Unit Baru</label><input type="text" id="bus-name" required></div>
            <div class="form-group"><label>Plat Nomor</label><input type="text" id="bus-plate" required></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>Pajak STNK</label><input type="date" id="bus-stnk"></div>
                <div class="form-group"><label>Pajak KIR</label><input type="date" id="bus-kir"></div>
            </div>
            <button type="submit" id="btn-save-bus" class="btn-green" style="width:100%">TAMBAH UNIT</button>
            <button type="button" id="btn-cancel-bus" class="btn-gray" style="width:100%; margin-top:5px; display:none;" onclick="resetFleetForm()">BATAL</button>
            <button type="button" class="btn-gray" style="width:100%; margin-top:5px;" onclick="closeModal()">TUTUP</button>
        </form>
    </div></div>

    <div id="modal-export" class="modal"><div class="modal-content">
        <h2>Export Laporan Bulanan</h2>
        <div class="form-group"><label>Pilih Periode:</label><input type="month" id="export-period" required></div>
        <div style="display:flex; gap:10px; margin-top:20px;"><button onclick="processExport()" class="btn-green" style="flex:2; justify-content:center">DOWNLOAD EXCEL (.XLS)</button><button onclick="closeModal()" class="btn-gray" style="flex:1">BATAL</button></div>
    </div></div>

    <script>
        const KEYS = { BUS: 'bus_pro_v39_buses', SCHED: 'bus_pro_v39_scheds', EXP: 'bus_pro_v39_exps' };
        let buses = [], schedules = [], expenses = [], currDate = new Date();
        let currentEditExpenseId = null;
        let myChart = null;

        // --- 1. SETTING FIREBASE (REPLACE URL DI SINI) ---
        const FIREBASE_URL = "https://bus-managemen-5fca8-default-rtdb.asia-southeast1.firebasedatabase.app/.json";

        // --- 2. FUNGSI SINKRON KE CLOUD ---
        async function saveToCloud() {
            if (FIREBASE_URL.includes("ISI_URL")) return;
            const data = { buses, schedules, expenses };
            try {
                await fetch(FIREBASE_URL, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                console.log("Awan: Data tersinkron ‚úÖ");
            } catch (err) {
                console.error("Awan: Gagal sinkron", err);
            }
        }

        // --- 3. MODIFIKASI FUNGSI SAVE ---
        function save() {
            localStorage.setItem(KEYS.BUS, JSON.stringify(buses));
            localStorage.setItem(KEYS.SCHED, JSON.stringify(schedules));
            localStorage.setItem(KEYS.EXP, JSON.stringify(expenses));
            saveToCloud(); // Sinkronkan setiap kali simpan
        }

        // --- 4. LOAD DATA (UTAMA) ---
        window.onload = async () => {
            // Load lokal dulu
            buses = JSON.parse(localStorage.getItem(KEYS.BUS)) || [];
            schedules = JSON.parse(localStorage.getItem(KEYS.SCHED)) || [];
            expenses = JSON.parse(localStorage.getItem(KEYS.EXP)) || [];
            renderAll();

            // Load dari Cloud
            if (!FIREBASE_URL.includes("ISI_URL")) {
                try {
                    const response = await fetch(FIREBASE_URL);
                    const cloudData = await response.json();
                    if (cloudData) {
                        buses = cloudData.buses || [];
                        schedules = cloudData.schedules || [];
                        expenses = cloudData.expenses || [];
                        save(); // Update lokal dengan data cloud
                        renderAll();
                        console.log("Awan: Data terbaru dimuat ‚òÅÔ∏è");
                    }
                } catch (err) {
                    console.log("Mode Offline aktif.");
                }
            }
        };

        // --- FUNGSI APLIKASI LAINNYA ---
        function formatRp(n) { return "Rp " + (parseInt(n)||0).toLocaleString('id-ID'); }
        function renderAll() { renderCalendar(); renderStats(); renderSidebar(); checkLegalAlerts(); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.getElementById('schedule-form').reset(); document.getElementById('expense-form').reset(); document.getElementById('edit-id').value = ''; currentEditExpenseId = null; }
        function changeMonth(dir) { currDate.setMonth(currDate.getMonth() + dir); renderAll(); }

        function updateFinanceChart(omzet, masuk, keluar, laba) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Target Omzet', 'Cash Masuk', 'Biaya Ops', 'Laba Bersih'],
                    datasets: [{
                        label: 'Rupiah (Rp)',
                        data: [omzet, masuk, keluar, laba],
                        backgroundColor: ['rgba(0, 90, 156, 0.4)', 'rgba(40, 167, 69, 0.4)', 'rgba(220, 53, 69, 0.4)', 'rgba(253, 126, 20, 0.4)'],
                        borderColor: ['#005a9c', '#28a745', '#dc3545', '#fd7e14'],
                        borderWidth: 2, borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderStats() {
            const mKey = `${currDate.getFullYear()}-${String(currDate.getMonth()+1).padStart(2,'0')}`;
            const fS = schedules.filter(s => s.date.startsWith(mKey));
            const fE = expenses.filter(e => e.date.startsWith(mKey));
            const omzet = fS.reduce((a,b) => a + (parseInt(b.price)||0), 0);
            const masuk = fS.reduce((a,b) => a + (parseInt(b.dp)||0), 0);
            const keluar = fE.reduce((a,b) => a + (parseInt(b.amount)||0), 0);
            const laba = masuk - keluar;
            document.getElementById('st-omzet').innerText = formatRp(omzet);
            document.getElementById('st-piutang').innerText = formatRp(omzet - masuk);
            document.getElementById('st-masuk').innerText = formatRp(masuk);
            document.getElementById('st-keluar').innerText = formatRp(keluar);
            document.getElementById('st-laba').innerText = formatRp(laba);
            renderExpensesTable(fE);
            updateFinanceChart(omzet, masuk, keluar, laba);
        }

        function renderExpensesTable(fE) {
            const tbody = document.getElementById('list-expenses-body'); tbody.innerHTML = '';
            fE.sort((a,b) => b.date.localeCompare(a.date)).forEach(e => {
                const b = buses.find(x => x.id == e.busId);
                tbody.innerHTML += `<tr><td style="padding:10px; border-bottom:1px solid #eee;">${e.date}</td><td style="padding:10px; border-bottom:1px solid #eee;">${b?.name || 'Kantor'}</td><td style="padding:10px; border-bottom:1px solid #eee;"><span class="badge" style="background:#eee;color:var(--dark)">${e.cat}</span></td><td style="padding:10px; border-bottom:1px solid #eee;">${e.desc || '-'}</td><td style="padding:10px; border-bottom:1px solid #eee; text-align:right"><b>${formatRp(e.amount)}</b></td><td style="padding:10px; border-bottom:1px solid #eee; text-align:center; display:flex; gap:5px; justify-content:center;"><button class="btn-orange" style="padding:4px 8px" onclick="editExpense(${e.id})">‚úèÔ∏è</button><button class="btn-red" style="padding:4px 8px" onclick="deleteExpense(${e.id})">üóëÔ∏è</button></td></tr>`;
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const y = currDate.getFullYear(), m = currDate.getMonth();
            document.getElementById('month-year').innerText = currDate.toLocaleString('id-ID', {month:'long', year:'numeric'});
            ['Min','Sen','Sel','Rab','Kam','Jum','Sab'].forEach(d => grid.innerHTML += `<div align="center" style="font-size:0.7rem; font-weight:bold; color:#888;">${d}</div>`);
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="day empty"></div>`;
            for(let i=1; i<=last; i++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'day'; dayEl.innerHTML = `<b>${i}</b>`;
                schedules.filter(s => s.date === dStr).forEach(s => {
                    const color = s.status === 'Lunas' ? 'var(--success)' : (s.status === 'DP' ? 'var(--warning)' : 'var(--danger)');
                    dayEl.innerHTML += `<div class="event" style="background:${color};">${s.trip}</div>`;
                });
                dayEl.onclick = () => openScheduleModal(dStr); grid.appendChild(dayEl);
            }
        }

        function renderSidebar() {
            const up = document.getElementById('list-upcoming'), un = document.getElementById('list-unpaid');
            up.innerHTML = ''; un.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            schedules.filter(s => s.date >= today).sort((a,b)=>a.date.localeCompare(b.date)).forEach(s => up.innerHTML += createCardHtml(s, false));
            schedules.filter(s => s.status !== 'Lunas').sort((a,b)=>a.date.localeCompare(b.date)).forEach(s => un.innerHTML += createCardHtml(s, true));
        }

        function createCardHtml(s, isUnpaidColumn) {
            const b = buses.find(x => x.id == s.busId); const sisa = (parseInt(s.price)||0) - (parseInt(s.dp)||0);
            const badgeClass = s.status === 'Lunas' ? 'badge-lunas' : (s.status === 'DP' ? 'badge-dp' : 'badge-blm');
            return `<div class="info-item" style="border-left-color: ${isUnpaidColumn ? 'var(--danger)' : 'var(--primary)'}"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><strong>${s.trip}</strong><span class="badge ${badgeClass}">${s.status}</span></div><div class="detail-row"><span>üìÖ <b>Tgl:</b> ${s.date}</span><span>üöå <b>Bus:</b> ${b?.name || '-'}</span><span style="display: flex; justify-content: space-between; width: 100%;"><span>üë§ <b>Pemesan:</b> ${s.cust}</span><span style="color: var(--primary); font-weight: 500;">üìû ${s.phone}</span></span></div><div class="pickup-box">üìç <b>Jemput:</b> ${s.pickup || '-'}</div><div style="margin-top:10px; border-top:1px dashed #eee; padding-top:8px;"><div style="font-weight:bold; color:${sisa > 0 ? 'var(--danger)' : 'var(--success)'}">${sisa > 0 ? 'Sisa Tagihan: ' + formatRp(sisa) : 'SUDAH LUNAS'}</div></div><div style="display:flex; gap:5px; margin-top:10px; flex-wrap:wrap;"><button class="btn-orange" onclick="editSched(${s.id})">‚úèÔ∏è Edit</button><button class="btn-gray" onclick="printInvoice(${s.id})">üìÑ Kwitansi</button><button class="btn-green" onclick="sendWA(${s.id})">üì± WA</button><button class="btn-red" onclick="delSched(${s.id})">üóëÔ∏è Hapus</button></div></div>`;
        }

        function openScheduleModal(date = '') {
            const busSelect = document.getElementById('f-bus'); const dateInput = document.getElementById('f-date'); const editId = document.getElementById('edit-id').value;
            if (date) dateInput.value = date;
            const selectedDate = dateInput.value;
            const usedBusIds = schedules.filter(s => s.date === selectedDate && s.id != editId).map(s => String(s.busId));
            const availableBuses = buses.filter(b => !usedBusIds.includes(String(b.id)));
            busSelect.innerHTML = availableBuses.length === 0 ? '<option value="" disabled>‚ùå Semua sudah terbooking</option>' : availableBuses.map(b => `<option value="${b.id}">${b.name} (${b.plate})</option>`).join('');
            document.getElementById('modal-form').style.display = 'block';
        }

        document.getElementById('schedule-form').onsubmit = (e) => {
            e.preventDefault(); const id = document.getElementById('edit-id').value;
            const data = { id: id ? parseInt(id) : Date.now(), trip: document.getElementById('f-trip').value, date: document.getElementById('f-date').value, busId: document.getElementById('f-bus').value, cust: document.getElementById('f-cust').value, phone: document.getElementById('f-phone').value, addr: document.getElementById('f-addr').value, pickup: document.getElementById('f-pickup').value, price: parseInt(document.getElementById('f-price').value), status: document.getElementById('f-status').value, dp: parseInt(document.getElementById('f-dp').value) || 0 };
            if(data.status === 'Lunas') data.dp = data.price;
            if(id) schedules = schedules.map(s => s.id == id ? data : s); else schedules.push(data);
            save(); closeModal(); renderAll();
        };

        function editSched(id) {
            const s = schedules.find(x => x.id == id); document.getElementById('edit-id').value = s.id; openScheduleModal(s.date);
            document.getElementById('f-trip').value = s.trip; document.getElementById('f-bus').value = s.busId; document.getElementById('f-cust').value = s.cust; document.getElementById('f-phone').value = s.phone; document.getElementById('f-addr').value = s.addr; document.getElementById('f-pickup').value = s.pickup; document.getElementById('f-price').value = s.price; document.getElementById('f-status').value = s.status; toggleDP(s.status); document.getElementById('f-dp').value = s.dp;
        }

        function delSched(id) { if(confirm('Hapus jadwal ini?')) { schedules = schedules.filter(x => x.id !== id); save(); renderAll(); } }
        function toggleDP(val) { document.getElementById('dp-group').style.display = (val === 'DP') ? 'block' : 'none'; }
        function openExpenseModal() { document.getElementById('e-bus').innerHTML = '<option value="0">Kantor / Umum</option>' + buses.map(b => `<option value="${b.id}">${b.name}</option>`).join(''); document.getElementById('modal-expense').style.display = 'block'; }

        function editExpense(id) {
            const exp = expenses.find(x => x.id == id); if (!exp) return; currentEditExpenseId = id; openExpenseModal();
            document.getElementById('e-date').value = exp.date; document.getElementById('e-bus').value = exp.busId; document.getElementById('e-cat').value = exp.cat; document.getElementById('e-amount').value = exp.amount; document.getElementById('e-desc').value = exp.desc; document.getElementById('expense-modal-title').innerText = "Edit Biaya";
        }

        document.getElementById('expense-form').onsubmit = (e) => {
            e.preventDefault(); const data = { date: document.getElementById('e-date').value, busId: document.getElementById('e-bus').value, cat: document.getElementById('e-cat').value, amount: parseInt(document.getElementById('e-amount').value), desc: document.getElementById('e-desc').value };
            if (currentEditExpenseId) expenses = expenses.map(x => x.id === currentEditExpenseId ? { ...data, id: x.id } : x); else expenses.push({ ...data, id: Date.now() });
            save(); closeModal(); renderAll();
        };

        function deleteExpense(id) { if(confirm('Hapus data biaya ini?')) { expenses = expenses.filter(x => x.id !== id); save(); renderAll(); } }
        function openFleetModal() { renderFleetList(); document.getElementById('modal-fleet').style.display = 'block'; }
        function renderFleetList() { document.getElementById('fleet-list').innerHTML = buses.map(b => `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"><div><b>${b.name}</b> (${b.plate})</div><div><button class="btn-orange" onclick="editBus(${b.id})">‚úèÔ∏è</button><button class="btn-red" onclick="deleteBus(${b.id})">üóëÔ∏è</button></div></div>`).join(''); }

        document.getElementById('fleet-form').onsubmit = (e) => {
            e.preventDefault(); const id = document.getElementById('bus-edit-id').value;
            const data = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('bus-name').value, plate: document.getElementById('bus-plate').value, stnk: document.getElementById('bus-stnk').value, kir: document.getElementById('bus-kir').value };
            if(id) buses = buses.map(b => b.id == id ? data : b); else buses.push(data);
            save(); resetFleetForm(); renderFleetList(); renderAll();
        };

        function editBus(id) {
            const b = buses.find(x => x.id == id); document.getElementById('bus-edit-id').value = b.id; document.getElementById('bus-name').value = b.name; document.getElementById('bus-plate').value = b.plate; document.getElementById('bus-stnk').value = b.stnk; document.getElementById('bus-kir').value = b.kir; document.getElementById('fleet-form-title').innerText = 'Edit Unit'; document.getElementById('btn-save-bus').innerText = 'UPDATE UNIT'; document.getElementById('btn-cancel-bus').style.display = 'block';
        }

        function deleteBus(id) { if(confirm('Hapus unit ini?')) { buses = buses.filter(x => x.id !== id); save(); renderFleetList(); renderAll(); } }
        function resetFleetForm() { document.getElementById('fleet-form').reset(); document.getElementById('bus-edit-id').value = ''; document.getElementById('fleet-form-title').innerText = 'Tambah Unit Baru'; document.getElementById('btn-save-bus').innerText = 'TAMBAH UNIT'; document.getElementById('btn-cancel-bus').style.display = 'none'; }
        function checkLegalAlerts() { const container = document.getElementById('legal-alerts'); container.innerHTML = ''; buses.forEach(b => { [{t:'STNK', d:new Date(b.stnk)}, {t:'KIR', d:new Date(b.kir)}].forEach(a => { if(!a.d || isNaN(a.d)) return; const diff = Math.ceil((a.d - new Date()) / (1000 * 60 * 60 * 24)); if(diff <= 30) { const col = diff <= 0 ? 'var(--danger)' : '#856404'; container.innerHTML += `<div style="padding:10px; background:white; border-left:5px solid ${col}; margin-bottom:10px; font-size:0.8rem;">‚ö†Ô∏è <b>${b.name}</b>: Pajak ${a.t} ${diff <= 0 ? 'Mati!' : 'sisa ' + diff + ' hr'}</div>`; } }); }); }

        function printInvoice(id) {
            const s = schedules.find(x => x.id == id), b = buses.find(x => x.id == s.busId); const sisa = s.price - s.dp; const pWin = window.open('', '_blank');
            pWin.document.write(`<html><head><title>Kwitansi_${s.cust}</title><style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');body{font-family:'Inter',sans-serif;padding:20px;color:#333;background:#f0f0f0}.paper{background:white;width:210mm;min-height:148mm;margin:auto;padding:30px;box-sizing:border-box;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);position:relative;overflow:hidden}.watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-30deg);font-size:80px;font-weight:bold;color:rgba(0,128,0,0.1);border:10px solid rgba(0,128,0,0.1);padding:20px;border-radius:20px;pointer-events:none;z-index:0;text-transform:uppercase}.header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid #005a9c;padding-bottom:15px}.brand h1{margin:0;color:#005a9c;font-size:24px}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin:25px 0;font-size:13px}.info-box h4{margin:0 0 8px 0;color:#005a9c;text-transform:uppercase;border-bottom:1px solid #eee;padding-bottom:5px}.info-box p{margin:4px 0;display:flex}.info-box span{width:100px;color:#777;flex-shrink:0}table{width:100%;border-collapse:collapse;margin:20px 0;font-size:14px;z-index:1;position:relative}th{background:#005a9c;color:white;padding:12px;text-align:left}td{padding:12px;border-bottom:1px solid #eee}.footer-grid{display:grid;grid-template-columns:1.5fr 1fr;gap:20px;margin-top:20px}.totals{background:#f9f9f9;padding:15px;border-radius:5px}.total-row{display:flex;justify-content:space-between;padding:5px 0;font-size:14px}.grand-total{border-top:2px solid #005a9c;margin-top:10px;padding-top:10px;font-weight:bold;font-size:18px;color:#005a9c}.signature-area{display:flex;justify-content:space-between;margin-top:40px;text-align:center;font-size:13px}.sig-box{width:200px}.sig-space{height:70px}@media print{body{background:white;padding:0}.paper{box-shadow:none;border:none;width:100%}button{display:none}}</style></head><body><div class="paper">${s.status==='Lunas'?'<div class="watermark">LUNAS</div>':''}${s.status==='DP'?'<div class="watermark" style="color:rgba(255,165,0,0.1);border-color:rgba(255,165,0,0.1)">DP PAID</div>':''}<div class="header"><div class="brand"><h1>TISAL BUS MANAGER</h1><p>Jl. Raya Krajan - Semin Km.3 Krajan, Weru, Sukoharjo</p></div><div class="inv-title"><h2>KWITANSI</h2><p>#INV/${s.id}</p><p>${new Date(s.date).toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'})}</p></div></div><div class="info-grid"><div class="info-box"><h4>Informasi Penyewa</h4><p><span>Nama</span>: <b>${s.cust}</b></p><p><span>Telepon</span>: ${s.phone}</p><p><span>Alamat</span>: ${s.addr||'-'}</p></div><div class="info-box"><h4>Detail Perjalanan</h4><p><span>Tujuan</span>: <b>${s.trip}</b></p><p><span>Armada</span>: ${b?.name||'-'}</p></div></div><table><thead><tr><th>Deskripsi</th><th style="text-align:right">Harga</th></tr></thead><tbody><tr><td><b>Sewa Bus Pariwisata</b><br><small>Tgl: ${s.date}</small></td><td style="text-align:right"><b>${formatRp(s.price)}</b></td></tr></tbody></table><div class="footer-grid"><div class="terms"><b>S&K:</b><ol><li>DP Min 30%.</li><li>Lunas H-3.</li></ol></div><div class="totals"><div class="total-row"><span>Total</span><span>${formatRp(s.price)}</span></div><div class="total-row" style="color:green"><span>Bayar</span><span>${formatRp(s.dp)}</span></div><div class="total-row grand-total"><span>${sisa>0?'SISA':'KETERANGAN'}</span><span>${sisa>0?formatRp(sisa):'LUNAS'}</span></div></div></div><div class="signature-area"><div class="sig-box"><p>Hormat Kami,</p><div class="sig-space"></div><p><b>( ___________ )</b></p></div><div class="sig-box"><p>Penyewa,</p><div class="sig-space"></div><p><b>( ${s.cust} )</b></p></div></div></div><script>window.onload=function(){setTimeout(()=>{window.print();},500);}<\/script></body></html>`);
            pWin.document.close();
        }

        function sendWA(id) {
            const s = schedules.find(x => x.id == id), b = buses.find(x => x.id == s.busId); const sisa = (parseInt(s.price) || 0) - (parseInt(s.dp) || 0); const statusTagihan = sisa > 0 ? `Sisa: *${formatRp(sisa)}*` : `*STATUS: LUNAS* ‚úÖ`;
            const rawMsg = `*KONFIRMASI RESERVASI BUS*\n------------------\nKak *${s.cust}*\nTrip: ${s.trip}\nTgl: ${new Date(s.date).toLocaleDateString('id-ID')}\nBus: ${b?.name || '-'}\n------------------\nTotal: ${formatRp(s.price)}\nDP: ${formatRp(s.dp)}\n${statusTagihan}\n------------------\nTerima kasih! üôè`;
            let phone = s.phone.replace(/\D/g, ''); if (phone.startsWith('0')) phone = '62' + phone.substring(1);
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(rawMsg)}`);
        }

        function openExportModal() { document.getElementById('modal-export').style.display = 'block'; }
        function processExport() {
            const period = document.getElementById('export-period').value; if (!period) return alert("Pilih bulan!");
            const fs = schedules.filter(s => s.date.startsWith(period)), fe = expenses.filter(e => e.date.startsWith(period));
            let html = `<html xmlns:x="urn:schemas-microsoft-com:office:excel"><body><table border="1"><tr><th colspan="7">LAPORAN ${period}</th></tr><tr><th>Tgl</th><th>Trip</th><th>Customer</th><th>Bus</th><th>Harga</th><th>DP</th><th>Status</th></tr>`;
            fs.forEach(s => { const b = buses.find(x => x.id == s.busId); html += `<tr><td>${s.date}</td><td>${s.trip}</td><td>${s.cust}</td><td>${b?.name}</td><td>${s.price}</td><td>${s.dp}</td><td>${s.status}</td></tr>`; });
            html += `</table></body></html>`;
            const blob = new Blob([html], { type: 'application/vnd.ms-excel' }); const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href = url; a.download = `Laporan_${period}.xls`; a.click(); closeModal();
        }

        function exportBackup() { const data = { buses, schedules, expenses }; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${Date.now()}.json`; a.click(); }
        function importData(e) { const reader = new FileReader(); reader.onload = (ev) => { const data = JSON.parse(ev.target.result); if(confirm('Restore data?')) { buses = data.buses || []; schedules = data.schedules || []; expenses = data.expenses || []; save(); renderAll(); } }; reader.readAsText(e.target.files[0]); }
    </script>
</body>
</html>
